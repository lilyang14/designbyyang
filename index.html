<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作品集</title>
  <style>
    /* 页面整体 */
    :root {
      --bg: #1C1C1C;
      --skeleton: rgba(255,255,255,0.20); /* 白色 20% */
      --white: #FFFFFF;
    }
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--white);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    /* 内容容器：顶部内边距 60px，居中 */
    .wrap{
      padding-top:60px; /* 你要求的顶部间距 */
      display:flex;
      justify-content:center;
      box-sizing:border-box;
      min-height:100%;
    }

    /* 内容区宽度规则：手机 100%，桌面 65% 最大 1200px */
    .content {
      width:100%;
      box-sizing:border-box;
      margin:0;
    }
    @media (min-width: 768px) {
      .content {
        width:65vw;             /* 65% 窗口宽度 */
        max-width:1200px;      /* 最大 1200px */
      }
    }

    /* 每张图一项（无间距）*/
    .item {
      width:100%;
      margin:0;
      padding:0;
      overflow:hidden;
      position:relative;
      line-height:0; /* 去掉空隙 */
    }

    /* 图片样式：宽度 100%，高度自适应（宽度一致，高度不定） */
    .item img {
      display:block;
      width:100%;
      height:auto;
      object-fit:cover; /* 尽量填充宽度 */
      user-select:none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* 骨架占位：宽度与图片一致，高度 1080 px，Fill（填充）*/
    .skeleton {
      width:100%;
      height:1080px; /* 要求固定高度 1080 */
      background: var(--skeleton);
      display:block;
      box-sizing:border-box;
    }

    /* 网络异常 overlay */
    .overlay {
      position:fixed;
      inset:0;
      display:none; /* 默认隐藏 */
      justify-content:center;
      align-items:center;
      z-index:9999;
      background: rgba(0,0,0,0.6);
    }
    .overlay .box {
      text-align:center;
      color:var(--white);
    }
    .overlay p {
      margin:0 0 20px 0;
      font-size:16px;
    }
    .reload-btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:96px;
      height:36px;
      background:var(--white);
      color:var(--bg);
      border-radius:4px;
      font-size:14px;
      cursor:pointer;
      border:0;
    }

    /* 禁用图片右键菜单（兼容性） */
    img, .item {
      -webkit-touch-callout: none; /* iOS Safari */
    }

    /* 小屏时图片占满屏幕宽度（wrap 和 content 已处理） */
    @media (max-width: 767px) {
      .skeleton { height:1080px; } /* 保持骨架高度需求 */
    }

    /* 去掉任何默认的间距/边框等 */
    * { box-sizing:border-box; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="content" id="gallery" aria-live="polite">
      <!-- JS 会动态注入图片项（skeleton + img） -->
    </main>
  </div>

  <!-- 网络异常覆盖层 -->
  <div id="networkOverlay" class="overlay" role="alert" aria-hidden="true">
    <div class="box">
      <p>网络异常，请重新加载</p>
      <button id="reloadBtn" class="reload-btn">重新加载</button>
    </div>
  </div>

  <script>
    /***********************
     * 配置区（若需修改）
     ***********************/
    const basePath = './images/';         // images 文件夹（相对路径）
    const namePrefix = 'work';            // 文件名前缀 'work' -> work1.png
    const fileExt = '.png';               // 扩展名（.png/.jpg）
    const maxScan = 100;                  // 最大扫描数量，防止无限循环（不要改太小）
    /*************************************************
     * 加载逻辑说明（已实现）：
     * - 按顺序尝试加载 work1..workN，若遇到连续 3 个不存在，则认为到末尾停止（减小 404 请求）
     * - 每个图片项先渲染 skeleton（高度 1080），图片用 data-src，使用 IntersectionObserver 懒加载
     * - 网络异常检测：如果 navigator.onLine 为 false，或首张图片加载 error（非 404）时显示 overlay
     *************************************************/

    const gallery = document.getElementById('gallery');
    const overlay = document.getElementById('networkOverlay');
    const reloadBtn = document.getElementById('reloadBtn');

    reloadBtn.addEventListener('click', () => {
      location.reload();
    });

    // 监听在线/离线
    window.addEventListener('offline', () => showNetworkOverlay());
    window.addEventListener('online', () => {
      hideNetworkOverlay();
    });

    function showNetworkOverlay(){
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
    }
    function hideNetworkOverlay(){
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
    }

    // 防止页面内图片右键、拖拽
    document.addEventListener('contextmenu', function(e){
      if (e.target && e.target.tagName === 'IMG') {
        e.preventDefault();
      }
    });
    document.addEventListener('dragstart', function(e){
      if (e.target && e.target.tagName === 'IMG') e.preventDefault();
    });

    // 尝试按序检测文件是否存在，但避免浪费：连续错误计数机制
    async function probeSequentialImages() {
      const list = [];
      let consecutiveMissing = 0;
      for (let i = 1; i <= maxScan; i++) {
        const url = basePath + namePrefix + i + fileExt;
        try {
          // 使用 HEAD 请求先探测（fetch HEAD）以避免完整下载
          const res = await fetch(url, { method: 'HEAD' });
          if (res.ok) {
            list.push({index:i, url});
            consecutiveMissing = 0;
          } else {
            // 404 或其它状态
            consecutiveMissing++;
            if (consecutiveMissing >= 3) break; // 连续 3 个不存在就停止（可以减少无意义请求）
          }
        } catch (err) {
          // 网络错误（如离线、DNS 等）
          // 直接显示网络异常提示并停止列举
          console.error('probe error', err);
          showNetworkOverlay();
          return list;
        }
      }
      return list;
    }

    // 渲染占位并设置懒加载
    function renderList(items) {
      if (items.length === 0) {
        // 没有图片时展示空提示（可自定义）
        const p = document.createElement('p');
        p.textContent = '没有图片，请将 images/work1.png 等文件上传到 images 文件夹';
        gallery.appendChild(p);
        return;
      }

      // IntersectionObserver for lazy loading images
      const io = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target.querySelector('img[data-src]');
            if (img) {
              const src = img.dataset.src;
              // 开始加载真实图片
              img.src = src;
              img.onload = () => {
                // 图片加载完后移除 skeleton（通过隐藏 skeleton 节点）
                const sk = entry.target.querySelector('.skeleton');
                if (sk) sk.remove();
              };
              img.onerror = (e) => {
                // 如果图片 404，移除该项的 skeleton 并隐藏图片区域
                const sk = entry.target.querySelector('.skeleton');
                if (sk) sk.style.background = 'transparent';
                console.error('image load error', src, e);
                // 如果明显是网络问题（navigator.offline）显示 overlay
                if (!navigator.onLine) showNetworkOverlay();
              };
              img.removeAttribute('data-src');
            }
            observer.unobserve(entry.target);
          }
        });
      }, { root: null, rootMargin: '200px', threshold: 0.01 });

      // 按索引顺序渲染（items 已经是顺序）
      items.forEach(item => {
        const wrap = document.createElement('figure');
        wrap.className = 'item';

        const sk = document.createElement('div');
        sk.className = 'skeleton';
        wrap.appendChild(sk);

        const img = document.createElement('img');
        img.setAttribute('data-src', item.url);
        img.alt = `work${item.index}`;
        img.setAttribute('draggable', 'false');
        img.setAttribute('loading', 'lazy'); // 双重保险：原生懒加载 + IntersectionObserver
        // 禁用上下文菜单、选择
        img.oncontextmenu = (e) => e.preventDefault();
        img.onmousedown = (e) => { e.preventDefault(); return false; };

        wrap.appendChild(img);
        gallery.appendChild(wrap);

        io.observe(wrap);
      });
    }

    // 主流程
    (async function main(){
      // 先探测图片列表
      const items = await probeSequentialImages();
      renderList(items);

      // 如果探测时发现 navigator.offline 就立即提示
      if (!navigator.onLine) {
        showNetworkOverlay();
      }
    })();

  </script>
</body>
</html>
